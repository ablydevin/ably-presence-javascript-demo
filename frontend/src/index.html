<html>
  <head>
    <link rel="stylesheet" href="style.css" />
    <script src="https://cdn.ably.com/lib/ably.min-1.js"></script>
    <script src="https://unpkg.com/fireworks-js@2.x/dist/index.umd.js"></script>
    <script>
      const ably = new Ably.Realtime.Promise({
        authUrl: "/auth",
      });

      const initializeClient = async () => {
        const fireworks = new Fireworks.default(container);

        await ably.connection.once("connected");

        console.log("Connected to Ably!");

        channel = ably.channels.get("cat-jam");

        channel.presence.subscribe("enter", (member) => {
          memberListElement.innerHTML += `<li data-clientId='${member.clientId}'>${member.clientId} (${member.data})</li>`;
          //play a sound
        });

        //A member who was present has left the channel
        channel.presence.subscribe("leave", (member) => {
          memberListElement
            .querySelector(`[data-clientId="${member.clientId}"]`)
            ?.remove();
          //play a sound
          let beat = new Audio(`sounds/leave.mp3`);
          beat.play();
        });

        //An already present member has updated their member data
        channel.presence.subscribe("update", (member) => {
          console.log(member);
          let memberItemElement = memberListElement.querySelector(
            `[data-clientId="${member.clientId}"]`
          );
          memberItemElement.innerHTML = `${member.clientId} (${member.data})`;

          fireworks.launch(10);

          let beat = new Audio(`sounds/${member.data}.mp3`);
          beat.play();
        });

        channel.presence.subscribe("present", (member) => {
          //play a sound
          console.log("present");
          memberListElement.innerHTML += `<li data-clientId='${member.clientId}'>${member.clientId} (${member.data})</li>`;
        });

        channel.presence.enter("available");
      };
    </script>
  </head>
  <body class="fireworks">
    <aside>
      <h2>Who is here?</h2>
      <ul id="memberList"></ul>
    </aside>
    <div>
      <div class="button-container">
        <button type="button" onclick="channel?.presence.update('available')">
          Available
        </button>
        <button type="button" onclick="channel?.presence.update('away')">
          Away
        </button>
        <button type="button" onclick="channel?.presence.update('holiday')">
          Holiday
        </button>
        <button type="button" onclick="channel?.presence.update('napping')">
          Napping
        </button>
        <button type="button" onclick="channel?.presence.update('cats')">
          Cats
        </button>
      </div>
      <div>
        <button type="button" class="leaveButton" onclick="channel?.presence.leave()">
          Leave
        </button>
      </div>
    </div>
  </body>
  <script>
    const memberListElement = document.querySelector("#memberList");
    const container = document.querySelector(".fireworks");

    initializeClient();
  </script>
</html>
